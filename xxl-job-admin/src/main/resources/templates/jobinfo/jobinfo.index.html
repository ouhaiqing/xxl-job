<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:include="include :: commonStyle" />
    <!-- DataTables -->
    <link rel="stylesheet" th:href="@{/static/adminlte/bower_components/datatables.net-bs/css/dataTables.bootstrap.min.css}">
    <title th:text="#{admin_name}"></title>
</head>
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">
    <!-- header -->
    <th:block th:include="include :: commonHeader" />
    <!-- left -->
    <th:block th:include="include :: commonLeft('jobinfo')" />

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h1 th:text="#{jobinfo_name}"></h1>
        </section>

        <!-- Main content -->
        <section class="content">

            <div class="row">
                <div class="col-xs-3">
                    <div class="input-group">
                        <span class="input-group-addon" th:text="#{jobinfo_field_jobgroup}"></span>
                        <select class="form-control" id="jobGroup" >
                            <option th:each="group:${JobGroupList}" th:text="${group.title}" th:value="${group.id}" th:selected="${group.id == jobGroup}"></option>
                        </select>
                </div>
            </div>
            <div class="col-xs-1">
                <div class="input-group">
                    <select class="form-control" id="triggerStatus" >
                        <option value="-1"  th:text="#{system_all}"></option>
                        <option value="0"  th:text="#{jobinfo_opt_stop}"></option>
                        <option value="1"  th:text="#{jobinfo_opt_start}"></option>
                    </select>
                </div>
            </div>
            <div class="col-xs-2">
                <div class="input-group">
                    <input type="text" class="form-control" id="jobDesc" autocomplete="on" th:placeholder="#{system_please_input} + #{jobinfo_field_jobdesc}" >
                </div>
            </div>
            <div class="col-xs-2">
                <div class="input-group">
                    <input type="text" class="form-control" id="executorHandler" autocomplete="on" th:placeholder="#{system_please_input} + JobHandler" >
                </div>
            </div>
            <div class="col-xs-2">
                <div class="input-group">
                    <input type="text" class="form-control" id="author" autocomplete="on" th:placeholder="#{system_please_input} + #{jobinfo_field_author}" >
                </div>
            </div>
            <div class="col-xs-1">
                <button class="btn btn-block btn-info" id="searchBtn" th:text="#{system_search}"></button>
            </div>
            <div class="col-xs-1">
                <button class="btn btn-block btn-success add" type="button" th:text="#{jobinfo_field_add}"></button>
            </div>
    </div>

    <div class="row">
        <div class="col-xs-12">
            <div class="box">
                <!--<div class="box-header hide">
                    <h3 class="box-title">调度列表</h3>
                </div>-->
                <div class="box-body" >
                    <table id="job_list" class="table table-bordered table-striped" width="100%" >
                        <thead>
                        <tr>
                            <th name="id" th:text="#{jobinfo_field_id}"></th>
                            <th name="jobGroup" th:text="#{jobinfo_field_jobgroup}"></th>
                            <th name="jobDesc" th:text="#{jobinfo_field_jobdesc}"></th>
                            <th name="glueType" th:text="#{jobinfo_field_gluetype}"></th>
                            <th name="executorParam" th:text="#{jobinfo_field_executorparam}"></th>
                            <th name="jobCron" >Cron</th>
                            <th name="addTime" >addTime</th>
                            <th name="updateTime" >updateTime</th>
                            <th name="author"  th:text="#{jobinfo_field_author}"></th>
                            <th name="alarmEmail"  th:text="#{jobinfo_field_alarmemail}"></th>
                            <th name="triggerStatus"  th:text="#{system_status}"></th>
                            <th th:text="#{system_opt}"></th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot></tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    </section>
</div>

<!-- footer -->
    <th:block th:include="include :: commonFooter" />
</div>

<!-- job新增.模态框 -->
<div class="modal fade" id="addModal" tabindex="-1" role="dialog"  aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title"  th:text="#{jobinfo_field_add}"></h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal form" role="form" >
                    <div class="form-group">
                        <label for="firstname" class="col-sm-2 control-label" th:text="#{jobinfo_field_jobgroup}"><font color="red">*</font></label>
                        <div class="col-sm-4">
                            <select class="form-control" name="jobGroup" >
                                <option th:each="group:${JobGroupList}" th:text="${group.title}" th:value="${group.id}" th:selected="${group.id == jobGroup}"></option>
                            </select>
                        </div>
                    <label for="lastname" class="col-sm-2 control-label" th:text="#{jobinfo_field_jobdesc}"><font color="red">*</font></label>
                    <div class="col-sm-4"><input type="text" class="form-control" name="jobDesc" th:placeholder="#{system_please_input} + #{jobinfo_field_jobdesc}" maxlength="50" ></div>
            </div>
            <div class="form-group">
                <label for="firstname" class="col-sm-2 control-label" th:text="#{jobinfo_field_executorRouteStrategy}"><font color="red">*</font></label>
                <div class="col-sm-4">
                    <select class="form-control" name="executorRouteStrategy" >
                        <option th:each="item:${ExecutorRouteStrategyEnum}" th:text="${item.title}" th:value="${item}"></option>
                    </select>
                </div>
                <label for="lastname" class="col-sm-2 control-label">Cron<font color="red">*</font></label>
                <div class="col-sm-4"><input type="text" class="form-control" name="jobCron" th:placeholder="#{system_please_input} + Cron" maxlength="128" ></div>
            </div>
            <div class="form-group">
                <label for="firstname" class="col-sm-2 control-label" th:text="#{jobinfo_field_gluetype}"><font color="red">*</font></label>
                <div class="col-sm-4">
                    <select class="form-control glueType" name="glueType" >
                        <option th:each="item:${GlueTypeEnum}" th:text="${item.desc}" th:value="${item}"></option>
                    </select>
                </div>
                <label for="firstname" class="col-sm-2 control-label">JobHandler<font color="red">*</font></label>
                <div class="col-sm-4"><input type="text" class="form-control" name="executorHandler" th:placeholder="#{system_please_input} + JobHandler" maxlength="100" ></div>
            </div>
            <div class="form-group">
                <label for="firstname" class="col-sm-2 control-label" th:text="#{jobinfo_field_executorBlockStrategy}"><font color="red">*</font></label>
                <div class="col-sm-4">
                    <select class="form-control" name="executorBlockStrategy" >
                        <option th:each="item:${ExecutorBlockStrategyEnum}" th:text="${item.title}" th:value="${item}"></option>
                    </select>
                </div>
                <label for="lastname" class="col-sm-2 control-label" th:text="#{jobinfo_field_childJobId}"><font color="black">*</font></label>
                <div class="col-sm-4"><input type="text" class="form-control" name="childJobId" th:placeholder="#{jobinfo_field_childJobId_placeholder}" maxlength="100" ></div>
            </div>
            <div class="form-group">
                <label for="lastname" class="col-sm-2 control-label" th:text="#{jobinfo_field_timeout}"><font color="black">*</font></label>
                <div class="col-sm-4"><input type="text" class="form-control" name="executorTimeout" th:placeholder="#{jobinfo_field_executorTimeout_placeholder}" maxlength="6" ></div>
                <label for="lastname" class="col-sm-2 control-label" th:text="#{jobinfo_field_executorFailRetryCount}"><font color="black">*</font></label>
                <div class="col-sm-4"><input type="text" class="form-control" name="executorFailRetryCount" th:placeholder="#{jobinfo_field_executorFailRetryCount_placeholder}" maxlength="4" ></div>
            </div>
            <div class="form-group">
                <label for="lastname" class="col-sm-2 control-label" th:text="#{jobinfo_field_author}"><font color="red">*</font></label>
                <div class="col-sm-4"><input type="text" class="form-control" name="author" th:placeholder="#{system_please_input} + #{jobinfo_field_author}" maxlength="50" ></div>
                <label for="lastname" class="col-sm-2 control-label" th:text="#{jobinfo_field_alarmemail}"><font color="black">*</font></label>
                <div class="col-sm-4"><input type="text" class="form-control" name="alarmEmail" th:placeholder="#{jobinfo_field_alarmemail_placeholder}" maxlength="100" ></div>
            </div>
            <div class="form-group">
                <label for="firstname" class="col-sm-2 control-label" th:text="#{jobinfo_field_executorparam}"><font color="black">*</font></label>
                <div class="col-sm-10">
                    <textarea class="textarea form-control" name="executorParam" th:placeholder="#{system_please_input} + #{jobinfo_field_executorparam}" maxlength="512" style="height: 63px; line-height: 1.2;"></textarea>
                </div>
            </div>

            <hr>
            <div class="form-group">
                <div class="col-sm-offset-3 col-sm-6">
                    <button type="submit" class="btn btn-primary" th:text="#{system_save}"></button>
                    <button type="button" class="btn btn-default" data-dismiss="modal" th:text="#{system_cancel}"></button>
                </div>
            </div>

<input type="hidden" name="glueRemark" value="GLUE代码初始化" >
<textarea name="glueSource" style="display:none;" ></textarea>
<textarea class="glueSource_java" style="display:none;">
<th:block>
package com.xxl.job.service.handler;

import com.xxl.job.core.log.XxlJobLogger;
import com.xxl.job.core.biz.model.ReturnT;
import com.xxl.job.core.handler.IJobHandler;

public class DemoGlueJobHandler extends IJobHandler {

	@Override
	public ReturnT<String> execute(String param) throws Exception {
		XxlJobLogger.log("XXL-JOB, Hello World.");
		return ReturnT.SUCCESS;
	}

}
</th:block>


</textarea>
<textarea class="glueSource_shell" style="display:none;">
<th:block>
#!/bin/bash
echo "xxl-job: hello shell"

echo "[[#{jobinfo_script_location}]]：$0"
echo "[[#{jobinfo_field_executorparam}]]：$1"
echo "[[#{jobinfo_shard_index}]] = $2"
echo "[[#{jobinfo_shard_total}]] = $3"
<#--echo "参数数量：$#"
for param in $*
do
    echo "参数 : $param"
    sleep 1s
done-->

echo "Good bye!"
exit 0
</th:block>
</textarea>
<textarea class="glueSource_python" style="display:none;">
<th:block>
#!/usr/bin/python
# -*- coding: UTF-8 -*-
import time
import sys

print "xxl-job: hello python"

print "[[#{jobinfo_script_location}]]：", sys.argv[0]
print "[[#{jobinfo_field_executorparam}]]：", sys.argv[1]
print "[[#{jobinfo_shard_index}]]：", sys.argv[2]
print "[[#{jobinfo_shard_total}]]：", sys.argv[3]
<!--for i in range(1, len(sys.argv)):
	time.sleep(1)
	print "参数", i, sys.argv[i]-->

print "Good bye!"
exit(0)
<!--
import logging
logging.basicConfig(level=logging.DEBUG)
logging.info("脚本文件：" + sys.argv[0])
-->
</th:block>
</textarea>
<!--这里有问题，新建一个运行模式为 php 的任务后，GLUE 中没有下边的 php 代码-->
<textarea class="glueSource_php" style="display:none;">
<th:block>
<?php

    echo "xxl-job: hello php  \n";

    echo "[[#{jobinfo_script_location}]]：$argv[0]  \n";
    echo "[[#{jobinfo_field_executorparam}]]：$argv[1]  \n";
    echo "[[#{jobinfo_shard_index}]] = $argv[2]  \n";
    echo "[[#{jobinfo_shard_total}]] = $argv[3]  \n";

    echo "Good bye!  \n";
    exit(0);

?>
</th:block>
</textarea>
            <textarea class="glueSource_nodejs" style="display:none;"
                      th.text='
#!/usr/bin/env node
console.log("xxl-job: hello nodejs")

var arguments = process.argv

console.log("[[#{jobinfo_script_location}]]: " + arguments[1])
console.log("[[#{jobinfo_field_executorparam}]]: " + arguments[2])
console.log("[[#{jobinfo_shard_index}]]: " + arguments[3])
console.log("[[#{jobinfo_shard_total}]]: " + arguments[4])
<#--for (var i = 2; i < arguments.length; i++){
console.log("参数 %s = %s", (i-1), arguments[i]);
}-->

console.log("Good bye!")
process.exit(0)
'>

</textarea>

<textarea class="glueSource_powershell" style="display:none;">
<th:block>
Write-Host "xxl-job: hello powershell"

Write-Host "[[#{jobinfo_script_location}]]: " $MyInvocation.MyCommand.Definition
Write-Host "[[#{jobinfo_field_executorparam}]]: "
    if ($args.Count -gt 2) { $args[0..($args.Count-3)] }
Write-Host "[[#{jobinfo_shard_index}]]: " $args[$args.Count-2]
Write-Host "[[#{jobinfo_shard_total}]]: " $args[$args.Count-1]

Write-Host "Good bye!"
exit 0
</th:block>
</textarea>
            </form>
        </div>
    </div>
</div>
</div>

<!-- 更新.模态框 -->
<div class="modal fade" id="updateModal" tabindex="-1" role="dialog"  aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title"  th:text="#{jobinfo_field_update}"></h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal form" role="form" >
                    <div class="form-group">
                        <label for="firstname" class="col-sm-2 control-label" th:text="#{jobinfo_field_jobgroup}"><font color="red">*</font></label>
                        <div class="col-sm-4">
                            <select class="form-control" name="jobGroup" >
                                <option th:each="group:${JobGroupList}" th:text="${group.title}" th:value="${group.id}"></option>
                            </select>
                        </div>
                        <label for="lastname" class="col-sm-2 control-label" th:text="#{jobinfo_field_jobdesc}"><font color="red">*</font></label>
                        <div class="col-sm-4"><input type="text" class="form-control" name="jobDesc" th:placeholder="#{system_please_input} + #{jobinfo_field_jobdesc}" maxlength="50" ></div>
                    </div>
                    <div class="form-group">
                        <label for="firstname" class="col-sm-2 control-label" th:text="#{jobinfo_field_executorRouteStrategy}"><font color="red">*</font></label>
                        <div class="col-sm-4">
                            <select class="form-control" name="executorRouteStrategy" >
                                <option th:each="item:${ExecutorRouteStrategyEnum}" th:text="${item.title}" th:value="${item}"></option>
                            </select>
                        </div>
                        <label for="lastname" class="col-sm-2 control-label">Cron<font color="red">*</font></label>
                        <div class="col-sm-4"><input type="text" class="form-control" name="jobCron" th:placeholder="#{system_please_input} + Cron" maxlength="128" ></div>
                    </div>
                    <div class="form-group">
                        <label for="firstname" class="col-sm-2 control-label" th:text="#{jobinfo_field_gluetype}"><font color="red">*</font></label>
                        <div class="col-sm-4">
                            <select class="form-control glueType" name="glueType" disabled >
                                <option th:each="item:${GlueTypeEnum}" th:text="${item.desc}" th:value="${item}"></option>
                            </select>
                        </div>
                        <label for="firstname" class="col-sm-2 control-label">JobHandler<font color="red">*</font></label>
                        <div class="col-sm-4"><input type="text" class="form-control" name="executorHandler" th:placeholder="#{system_please_input} + JobHandler" maxlength="100" ></div>
                    </div>
                    <div class="form-group">
                        <label for="firstname" class="col-sm-2 control-label" th:text="#{jobinfo_field_executorBlockStrategy}"><font color="red">*</font></label>
                        <div class="col-sm-4">
                            <select class="form-control" name="executorBlockStrategy" >
                                <option th:each="item:${ExecutorBlockStrategyEnum}" th:text="${item.title}" th:value="${item}"></option>
                            </select>
                        </div>
                        <label for="lastname" class="col-sm-2 control-label" th:text="#{jobinfo_field_childJobId}"><font color="black">*</font></label>
                        <div class="col-sm-4"><input type="text" class="form-control" name="childJobId" th:placeholder="#{jobinfo_field_childJobId_placeholder}" maxlength="100" ></div>
                    </div>
                    <div class="form-group">
                        <label for="lastname" class="col-sm-2 control-label" th:text="#{jobinfo_field_timeout}"><font color="black">*</font></label>
                        <div class="col-sm-4"><input type="text" class="form-control" name="executorTimeout" th:placeholder="#{jobinfo_field_executorTimeout_placeholder}" maxlength="6" ></div>
                        <label for="lastname" class="col-sm-2 control-label" th:text="#{jobinfo_field_executorFailRetryCount}"><font color="black">*</font></label>
                        <div class="col-sm-4"><input type="text" class="form-control" name="executorFailRetryCount" th:placeholder="#{jobinfo_field_executorFailRetryCount_placeholder}" maxlength="4" ></div>
                    </div>
                    <div class="form-group">
                        <label for="lastname" class="col-sm-2 control-label" th:text="#{jobinfo_field_author}"><font color="red">*</font></label>
                        <div class="col-sm-4"><input type="text" class="form-control" name="author" th:placeholder="#{system_please_input} + #{jobinfo_field_author}" maxlength="50" ></div>
                        <label for="lastname" class="col-sm-2 control-label" th:text="#{jobinfo_field_alarmemail}"><font color="black">*</font></label>
                        <div class="col-sm-4"><input type="text" class="form-control" name="alarmEmail" th:placeholder="#{jobinfo_field_alarmemail_placeholder}" maxlength="100" ></div>
                    </div>
                    <div class="form-group">
                        <label for="firstname" class="col-sm-2 control-label" th:text="#{jobinfo_field_executorparam}"><font color="black">*</font></label>
                        <div class="col-sm-10">
                            <textarea class="textarea form-control" name="executorParam" th:placeholder="#{system_please_input} + #{jobinfo_field_executorparam}" maxlength="512" style="height: 63px; line-height: 1.2;"></textarea>
                        </div>
                    </div>

                    <hr>
                    <div class="form-group">
                        <div class="col-sm-offset-3 col-sm-6">
                            <button type="submit" class="btn btn-primary" th:text="#{system_save}"></button>
                            <button type="button" class="btn btn-default" data-dismiss="modal" th:text="#{system_cancel}"></button>
                            <input type="hidden" name="id" >
                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="jobTriggerModal" tabindex="-1" role="dialog"  aria-hidden="true">
    <div class="modal-dialog ">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title"  th:text="#{jobinfo_opt_run}"></h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal form" role="form" >
                    <div class="form-group">
                        <label for="firstname" class="col-sm-2 control-label" th:text="#{jobinfo_field_executorparam}"><font color="black">*</font></label>
                        <div class="col-sm-10">
                            <textarea class="textarea form-control" name="executorParam" th:placeholder="#{system_please_input} + #{jobinfo_field_executorparam} +  jobinfo_field_executorparam" maxlength="512" style="height: 63px; line-height: 1.2;"></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="firstname" class="col-sm-2 control-label" th:text="#{jobgroup_field_registryList}"><font color="black">*</font></label>
                        <div class="col-sm-10">
                            <textarea class="textarea form-control" name="addressList" th:placeholder="#{jobinfo_opt_run_tips}" maxlength="512" style="height: 63px; line-height: 1.2;"></textarea>
                        </div>
                    </div>
                    <hr>
                    <div class="form-group">
                        <div class="col-sm-offset-3 col-sm-6">
                            <button type="button" class="btn btn-primary ok"  th:text="#{system_save}"></button>
                            <button type="button" class="btn btn-default" data-dismiss="modal" th:text="#{system_cancel}"></button>
                            <input type="hidden" name="id" >
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<th:block th:include="include :: commonScript" />
<!-- DataTables -->
<script th:src="@{/static/adminlte/bower_components/datatables.net/js/jquery.dataTables.min.js}"></script>
<script th:src="@{/static/adminlte/bower_components/datatables.net-bs/js/dataTables.bootstrap.min.js}"></script>
<!-- moment -->
<script th:src="@{/static/adminlte/bower_components/moment/moment.min.js}"></script>
<script th:src="@{/static/plugins/cronGen/cronGen.js}"></script>
<!--<script th:src="@{/static/js/jobinfo.index.1.js"></script>-->

<script type="text/javascript" th:inline="javascript">
    $(function() {

        // init date tables
        var jobTable = $("#job_list").dataTable({
            "deferRender": true,
            "processing" : true,
            "serverSide": true,
            "ajax": {
                url: base_url + "/jobinfo/pageList",
                type:"post",
                data : function ( d ) {
                    var obj = {};
                    obj.jobGroup = $('#jobGroup').val();
                    obj.triggerStatus = $('#triggerStatus').val();
                    obj.jobDesc = $('#jobDesc').val();
                    obj.executorHandler = $('#executorHandler').val();
                    obj.author = $('#author').val();
                    obj.start = d.start;
                    obj.length = d.length;
                    return obj;
                }
            },
            "searching": false,
            "ordering": false,
            //"scrollX": true,	// scroll x，close self-adaption
            "columns": [
                {
                    "data": 'id',
                    "bSortable": false,
                    "visible" : true,
                    "width":'7%'
                },
                {
                    "data": 'jobGroup',
                    "visible" : false,
                    "render": function ( data, type, row ) {
                        var groupMenu = $("#jobGroup").find("option");
                        for ( var index in $("#jobGroup").find("option")) {
                            if ($(groupMenu[index]).attr('value') == data) {
                                return $(groupMenu[index]).html();
                            }
                        }
                        return data;
                    }
                },
                {
                    "data": 'jobDesc',
                    "visible" : true,
                    "width":'25%'
                },
                {
                    "data": 'glueType',
                    "width":'25%',
                    "visible" : true,
                    "render": function ( data, type, row ) {
                        var glueTypeTitle = findGlueTypeTitle(row.glueType);
                        if (row.executorHandler) {
                            return glueTypeTitle +"：" + row.executorHandler;
                        } else {
                            return glueTypeTitle;
                        }
                    }
                },
                { "data": 'executorParam', "visible" : false},
                {
                    "data": 'jobCron',
                    "visible" : true,
                    "width":'13%'
                },
                {
                    "data": 'addTime',
                    "visible" : false,
                    "render": function ( data, type, row ) {
                        return data?moment(new Date(data)).format("YYYY-MM-DD HH:mm:ss"):"";
                    }
                },
                {
                    "data": 'updateTime',
                    "visible" : false,
                    "render": function ( data, type, row ) {
                        return data?moment(new Date(data)).format("YYYY-MM-DD HH:mm:ss"):"";
                    }
                },
                { "data": 'author', "visible" : true, "width":'10%'},
                { "data": 'alarmEmail', "visible" : false},
                {
                    "data": 'triggerStatus',
                    "width":'10%',
                    "visible" : true,
                    "render": function ( data, type, row ) {
                        // status
                        if (1 == data) {
                            return '<small class="label label-success" >RUNNING</small>';
                        } else {
                            return '<small class="label label-default" >STOP</small>';
                        }
                        return data;
                    }
                },
                {
                    "data": [[#{system_opt}]] ,
						"width":'10%',
	                	"render": function ( data, type, row ) {
	                		return function(){

                                // status
                                var start_stop_div = "";
                                if (1 == row.triggerStatus ) {
                                    start_stop_div = '<li><a href="javascript:void(0);" class="job_operate" _type="job_pause" >'+ [[#{jobinfo_opt_stop}]] +'</a></li>\n';
                                } else {
                        start_stop_div = '<li><a href="javascript:void(0);" class="job_operate" _type="job_resume" >'+ [[#{jobinfo_opt_start}]] +'</a></li>\n';
                                }

                        // log url
                        var logHref = base_url +'/joblog?jobId='+ row.id;

        // log url
        var codeBtn = "";
        if ('BEAN' != row.glueType) {
            var codeUrl = base_url +'/jobcode?jobId='+ row.id;
            codeBtn = '<li><a href="'+ codeUrl +'" target="_blank" >GLUE IDE</a></li>\n';
            codeBtn += '<li class="divider"></li>\n';
        }

        // data
        tableData['key'+row.id] = row;

        // opt
        var html = '<div class="btn-group">\n' +
            '     <button type="button" class="btn btn-primary btn-sm">'+ [[#{system_opt}]] +'</button>\n' +
                                    '     <button type="button" class="btn btn-primary btn-sm dropdown-toggle" data-toggle="dropdown">\n' +
                                    '       <span class="caret"></span>\n' +
                                    '       <span class="sr-only">Toggle Dropdown</span>\n' +
                                    '     </button>\n' +
                                    '     <ul class="dropdown-menu" role="menu" _id="'+ row.id +'" >\n' +
                                    '       <li><a href="javascript:void(0);" class="job_trigger" >'+ [[#{jobinfo_opt_run}]] +'</a></li>\n' +
                                    '       <li><a href="'+ logHref +'">'+ [[#{jobinfo_opt_log}]] +'</a></li>\n' +
                                    '       <li><a href="javascript:void(0);" class="job_registryinfo" >' + [[#{jobinfo_opt_registryinfo}]] + '</a></li>\n' +
                                    '       <li><a href="javascript:void(0);" class="job_next_time" >' + [[#{jobinfo_opt_next_time}]] + '</a></li>\n' +
                                    '       <li class="divider"></li>\n' +
                                    codeBtn +
                                    start_stop_div +
                                    '       <li><a href="javascript:void(0);" class="update" >'+ [[#{system_opt_edit}]] +'</a></li>\n' +
                                    '       <li><a href="javascript:void(0);" class="job_operate" _type="job_del" >'+ [[#{system_opt_del}]] +'</a></li>\n' +
									'       <li><a href="javascript:void(0);" class="job_copy" >'+ [[#{system_opt_copy}]] +'</a></li>\n' +
                                    '     </ul>\n' +
                                    '   </div>';

	                			return html;
							};
    }
    }
    ],
        "language" : {
            "sProcessing" : [[#{dataTable_sProcessing}]] ,
			"sLengthMenu" : [[#{dataTable_sLengthMenu}]] ,
			"sZeroRecords" : [[#{dataTable_sZeroRecords}]] ,
			"sInfo" : [[#{dataTable_sInfo}]] ,
			"sInfoEmpty" : [[#{dataTable_sInfoEmpty}]] ,
			"sInfoFiltered" : [[#{dataTable_sInfoFiltered}]] ,
			"sInfoPostFix" : "",
			"sSearch" : [[#{dataTable_sSearch}]] ,
			"sUrl" : "",
			"sEmptyTable" : [[#{dataTable_sEmptyTable}]] ,
			"sLoadingRecords" : [[#{dataTable_sLoadingRecords}]] ,
			"sInfoThousands" : ",",
			"oPaginate" : {
				"sFirst" : [[#{dataTable_sFirst}]] ,
				"sPrevious" : [[#{dataTable_sPrevious}]] ,
				"sNext" : [[#{dataTable_sNext}]] ,
				"sLast" : [[#{dataTable_sLast}]]
			},
                "oAria" : {
                "sSortAscending" : [[#{dataTable_sSortAscending}]] ,
				"sSortDescending" : [[#{dataTable_sSortDescending}]]
			}
            }
        });

        // table data
        var tableData = {};

        // search btn
        $('#searchBtn').on('click', function(){
            jobTable.fnDraw();
        });

        // jobGroup change
        $('#jobGroup').on('change', function(){
            //reload
            var jobGroup = $('#jobGroup').val();
            window.location.href = base_url + "/jobinfo?jobGroup=" + jobGroup;
        });

        // job operate
        $("#job_list").on('click', '.job_operate',function() {
            var typeName;
            var url;
            var needFresh = false;

            var type = $(this).attr("_type");
            if ("job_pause" == type) {
                typeName = [[#{jobinfo_opt_stop}]] ;
			url = base_url + "/jobinfo/stop";
			needFresh = true;
		} else if ("job_resume" == type) {
                    typeName = [[#{jobinfo_opt_start}]] ;
			url = base_url + "/jobinfo/start";
			needFresh = true;
		} else if ("job_del" == type) {
                        typeName = [[#{system_opt_del}]] ;
			url = base_url + "/jobinfo/remove";
			needFresh = true;
		} else {
                            return;
                        }

                        var id = $(this).parents('ul').attr("_id");

                        layer.confirm( [[#{system_ok}]] + typeName + '?', {
			icon: 3,
			title: [[#{system_tips}]] ,
            btn: [ [[#{system_ok}]], [[#{system_cancel}]] ]
		}, function(index){
                            layer.close(index);

                            $.ajax({
                                type : 'POST',
                                url : url,
                                data : {
                                    "id" : id
                                },
                                dataType : "json",
                                success : function(data){
                                    if (data.code == 200) {
                                        layer.msg( typeName + [[#{system_success}]] );
                        if (needFresh) {
                            //window.location.reload();
                            jobTable.fnDraw(false);
                        }
                                    } else {
                                        layer.msg( data.msg || typeName + [[#{system_fail}]] );
					}
                                    }
                                });
                        });
                    });

        // job trigger
        $("#job_list").on('click', '.job_trigger',function() {
            var id = $(this).parents('ul').attr("_id");
            var row = tableData['key'+id];

            $("#jobTriggerModal .form input[name='id']").val( row.id );
            $("#jobTriggerModal .form textarea[name='executorParam']").val( row.executorParam );

            $('#jobTriggerModal').modal({backdrop: false, keyboard: false}).modal('show');
        });
        $("#jobTriggerModal .ok").on('click',function() {
            $.ajax({
                type : 'POST',
                url : base_url + "/jobinfo/trigger",
                data : {
                    "id" : $("#jobTriggerModal .form input[name='id']").val(),
                    "executorParam" : $("#jobTriggerModal .textarea[name='executorParam']").val(),
                    "addressList" : $("#jobTriggerModal .textarea[name='addressList']").val()
                },
                dataType : "json",
                success : function(data){
                    if (data.code == 200) {
                        $('#jobTriggerModal').modal('hide');

                        layer.msg( [[#{jobinfo_opt_run}]] + [[#{system_success}]] );
                } else {
                            layer.msg( data.msg || [[#{jobinfo_opt_run}]] + [[#{system_fail}]] );
                }
                        }
                    });
        });
        $("#jobTriggerModal").on('hide.bs.modal', function () {
            $("#jobTriggerModal .form")[0].reset();
        });


        // job registryinfo
        $("#job_list").on('click', '.job_registryinfo',function() {
            var id = $(this).parents('ul').attr("_id");
            var row = tableData['key'+id];

            var jobGroup = row.jobGroup;

            $.ajax({
                type : 'POST',
                url : base_url + "/jobgroup/loadById",
                data : {
                    "id" : jobGroup
                },
                dataType : "json",
                success : function(data){

                    var html = '<div>';
                    if (data.code == 200 && data.content.registryList) {
                        for (var index in data.content.registryList) {
                            html += (parseInt(index)+1) + '. <span class="badge bg-green" >' + data.content.registryList[index] + '</span><br>';
                        }
                    }
                    html += '</div>';

                    layer.open({
                        title: [[#{jobinfo_opt_registryinfo}]] ,
                    btn: [ [[#{system_ok}]] ],
                    content: html
                });

                }
            });

        });

        // job_next_time
        $("#job_list").on('click', '.job_next_time',function() {
            var id = $(this).parents('ul').attr("_id");
            var row = tableData['key'+id];

            var jobCron = row.jobCron;

            $.ajax({
                type : 'POST',
                url : base_url + "/jobinfo/nextTriggerTime",
                data : {
                    "cron" : jobCron
                },
                dataType : "json",
                success : function(data){

                    if (data.code != 200) {
                        layer.open({
                            title: [[#{jobinfo_opt_next_time}]] ,
                        btn: [ [[#{system_ok}]] ],
                        content: data.msg
                    });
                    } else {
                        var html = '<center>';
                        if (data.code == 200 && data.content) {
                            for (var index in data.content) {
                                html += '<span>' + data.content[index] + '</span><br>';
                            }
                        }
                        html += '</center>';

                        layer.open({
                            title: [[#{jobinfo_opt_next_time}]] ,
                        btn: [ [[#{system_ok}]] ],
                        content: html
                    });
                    }

                }
            });

        });

        // add
        $(".add").click(function(){

            // init-cronGen
            $("#addModal .form input[name='jobCron']").show().siblings().remove();
            $("#addModal .form input[name='jobCron']").cronGen({});

            $('#addModal').modal({backdrop: false, keyboard: false}).modal('show');
        });
        var addModalValidate = $("#addModal .form").validate({
            errorElement : 'span',
            errorClass : 'help-block',
            focusInvalid : true,
            rules : {
                jobDesc : {
                    required : true,
                    maxlength: 50
                },
                jobCron : {
                    required : true
                },
                author : {
                    required : true
                },
                executorTimeout : {
                    digits:true
                },
                executorFailRetryCount : {
                    digits:true
                }
            },
            messages : {
                jobDesc : {
                    required : [[#{system_please_input}]] + [[#{jobinfo_field_jobdesc}]]
            },
                        jobCron : {
            required : [[#{system_please_input}]] + "Cron"
            },
                author : {
                required : [[#{system_please_input}]] + [[#{jobinfo_field_author}]]
            },
                    executorTimeout : {
                    digits: [[#{system_please_input}]] + [[#{system_digits}]]
            },
                        executorFailRetryCount : {
                        digits: [[#{system_please_input}]] + [[#{system_digits}]]
            }
                    },
                    highlight : function(element) {
                        $(element).closest('.form-group').addClass('has-error');
                    },
                    success : function(label) {
                        label.closest('.form-group').removeClass('has-error');
                        label.remove();
                    },
                    errorPlacement : function(error, element) {
                        element.parent('div').append(error);
                    },
                    submitHandler : function(form) {

                        // process
                        var executorTimeout = $("#addModal .form input[name='executorTimeout']").val();
                        if(!/^\d+$/.test(executorTimeout)) {
                            executorTimeout = 0;
                        }
                        $("#addModal .form input[name='executorTimeout']").val(executorTimeout);
                        var executorFailRetryCount = $("#addModal .form input[name='executorFailRetryCount']").val();
                        if(!/^\d+$/.test(executorFailRetryCount)) {
                            executorFailRetryCount = 0;
                        }
                        $("#addModal .form input[name='executorFailRetryCount']").val(executorFailRetryCount);

                        // process-cronGen
                        $("#addModal .form input[name='jobCron']").val( $("#addModal .form input[name='cronGen_display']").val() );

                        $.post(base_url + "/jobinfo/add",  $("#addModal .form").serialize(), function(data, status) {
                            if (data.code == "200") {
                                $('#addModal').modal('hide');
                                layer.open({
                                    title: [[#{system_tips}]] ,
                        btn: [ [[#{system_ok}]] ],
						content: [[#{system_add_suc}]] ,
						icon: '1',
						end: function(layero, index){
							jobTable.fnDraw();
							//window.location.reload();
						}
                                });
                            } else {
                                layer.open({
                                    title: [[#{system_tips}]] ,
                        btn: [ [[#{system_ok}]] ],
						content: (data.msg || [[#{system_add_fail}]]),
						icon: '2'
					});
                            }
                        });
                    }
                });
        $("#addModal").on('hide.bs.modal', function () {
            addModalValidate.resetForm();
            $("#addModal .form")[0].reset();
            $("#addModal .form .form-group").removeClass("has-error");
            $(".remote_panel").show();	// remote

            $("#addModal .form input[name='executorHandler']").removeAttr("readonly");
        });


        // glueType change
        $(".glueType").change(function(){
            // executorHandler
            var $executorHandler = $(this).parents("form").find("input[name='executorHandler']");
            var glueType = $(this).val();
            if ('BEAN' != glueType) {
                $executorHandler.val("");
                $executorHandler.attr("readonly","readonly");
            } else {
                $executorHandler.removeAttr("readonly");
            }
        });

        $("#addModal .glueType").change(function(){
            // glueSource
            var glueType = $(this).val();
            if ('GLUE_GROOVY'==glueType){
                $("#addModal .form textarea[name='glueSource']").val( $("#addModal .form .glueSource_java").val() );
            } else if ('GLUE_SHELL'==glueType){
                $("#addModal .form textarea[name='glueSource']").val( $("#addModal .form .glueSource_shell").val() );
            } else if ('GLUE_PYTHON'==glueType){
                $("#addModal .form textarea[name='glueSource']").val( $("#addModal .form .glueSource_python").val() );
            } else if ('GLUE_PHP'==glueType){
                $("#addModal .form textarea[name='glueSource']").val( $("#addModal .form .glueSource_php").val() );
            } else if ('GLUE_NODEJS'==glueType){
                $("#addModal .form textarea[name='glueSource']").val( $("#addModal .form .glueSource_nodejs").val() );
            } else if ('GLUE_POWERSHELL'==glueType){
                $("#addModal .form textarea[name='glueSource']").val( $("#addModal .form .glueSource_powershell").val() );
            } else {
                $("#addModal .form textarea[name='glueSource']").val("");
            }
        });

        // update
        $("#job_list").on('click', '.update',function() {

            var id = $(this).parents('ul').attr("_id");
            var row = tableData['key'+id];

            // base data
            $("#updateModal .form input[name='id']").val( row.id );
            $('#updateModal .form select[name=jobGroup] option[value='+ row.jobGroup +']').prop('selected', true);
            $("#updateModal .form input[name='jobDesc']").val( row.jobDesc );
            $("#updateModal .form input[name='jobCron']").val( row.jobCron );
            $("#updateModal .form input[name='author']").val( row.author );
            $("#updateModal .form input[name='alarmEmail']").val( row.alarmEmail );
            $("#updateModal .form input[name='executorTimeout']").val( row.executorTimeout );
            $("#updateModal .form input[name='executorFailRetryCount']").val( row.executorFailRetryCount );
            $('#updateModal .form select[name=executorRouteStrategy] option[value='+ row.executorRouteStrategy +']').prop('selected', true);
            $("#updateModal .form input[name='executorHandler']").val( row.executorHandler );
            $("#updateModal .form textarea[name='executorParam']").val( row.executorParam );
            $("#updateModal .form input[name='childJobId']").val( row.childJobId );
            $('#updateModal .form select[name=executorBlockStrategy] option[value='+ row.executorBlockStrategy +']').prop('selected', true);
            $('#updateModal .form select[name=glueType] option[value='+ row.glueType +']').prop('selected', true);

            $("#updateModal .form select[name=glueType]").change();

            // init-cronGen
            $("#updateModal .form input[name='jobCron']").show().siblings().remove();
            $("#updateModal .form input[name='jobCron']").cronGen({});

            // show
            $('#updateModal').modal({backdrop: false, keyboard: false}).modal('show');
        });
        var updateModalValidate = $("#updateModal .form").validate({
            errorElement : 'span',
            errorClass : 'help-block',
            focusInvalid : true,

            rules : {
                jobDesc : {
                    required : true,
                    maxlength: 50
                },
                jobCron : {
                    required : true
                },
                author : {
                    required : true
                },
                executorTimeout : {
                    digits:true
                },
                executorFailRetryCount : {
                    digits:true
                }
            },
            messages : {
                jobDesc : {
                    required : [[#{system_please_input}]] + [[#{jobinfo_field_jobdesc}]]
			},
                        jobCron : {
            required : [[#{system_please_input}]] + "Cron"
			},
                author : {
                required : [[#{system_please_input}]] + [[#{jobinfo_field_author}]]
			},
                    executorTimeout : {
                    digits: [[#{system_please_input}]] + [[#{system_digits}]]
            },
                        executorFailRetryCount : {
                        digits: [[#{system_please_input}]] + [[#{system_digits}]]
            }
                    },
                    highlight : function(element) {
                        $(element).closest('.form-group').addClass('has-error');
                    },
                    success : function(label) {
                        label.closest('.form-group').removeClass('has-error');
                        label.remove();
                    },
                    errorPlacement : function(error, element) {
                        element.parent('div').append(error);
                    },
                    submitHandler : function(form) {

                        // process
                        var executorTimeout = $("#updateModal .form input[name='executorTimeout']").val();
                        if(!/^\d+$/.test(executorTimeout)) {
                            executorTimeout = 0;
                        }
                        $("#updateModal .form input[name='executorTimeout']").val(executorTimeout);
                        var executorFailRetryCount = $("#updateModal .form input[name='executorFailRetryCount']").val();
                        if(!/^\d+$/.test(executorFailRetryCount)) {
                            executorFailRetryCount = 0;
                        }
                        $("#updateModal .form input[name='executorFailRetryCount']").val(executorFailRetryCount);

                        // process-cronGen
                        $("#updateModal .form input[name='jobCron']").val( $("#updateModal .form input[name='cronGen_display']").val() );

                        // post
                        $.post(base_url + "/jobinfo/update", $("#updateModal .form").serialize(), function(data, status) {
                            if (data.code == "200") {
                                $('#updateModal').modal('hide');
                                layer.open({
                                    title: [[#{system_tips}]] ,
                        btn: [ [[#{system_ok}]] ],
						content: [[#{system_update_suc}]] ,
						icon: '1',
						end: function(layero, index){
							//window.location.reload();
							jobTable.fnDraw();
						}
                                });
                            } else {
                                layer.open({
                                    title: [[#{system_tips}]] ,
                        btn: [ [[#{system_ok}]] ],
						content: (data.msg || [[#{system_update_fail}]] ),
						icon: '2'
					});
                            }
                        });
                    }
                });
        $("#updateModal").on('hide.bs.modal', function () {
            updateModalValidate.resetForm();
            $("#updateModal .form")[0].reset();
            $("#updateModal .form .form-group").removeClass("has-error");
        });

        /**
         * find title by name, GlueType
         */
        function findGlueTypeTitle(glueType) {
            var glueTypeTitle;
            $("#addModal .form select[name=glueType] option").each(function () {
                var name = $(this).val();
                var title = $(this).text();
                if (glueType == name) {
                    glueTypeTitle = title;
                    return false
                }
            });
            return glueTypeTitle;
        }

        // job_copy
        $("#job_list").on('click', '.job_copy',function() {

            var id = $(this).parents('ul').attr("_id");
            var row = tableData['key'+id];

            // base data
            //$("#addModal .form input[name='id']").val( row.id );
            $('#addModal .form select[name=jobGroup] option[value='+ row.jobGroup +']').prop('selected', true);
            $("#addModal .form input[name='jobDesc']").val( row.jobDesc );
            $("#addModal .form input[name='jobCron']").val( row.jobCron );
            $("#addModal .form input[name='author']").val( row.author );
            $("#addModal .form input[name='alarmEmail']").val( row.alarmEmail );
            $("#addModal .form input[name='executorTimeout']").val( row.executorTimeout );
            $("#addModal .form input[name='executorFailRetryCount']").val( row.executorFailRetryCount );
            $('#addModal .form select[name=executorRouteStrategy] option[value='+ row.executorRouteStrategy +']').prop('selected', true);
            $("#addModal .form input[name='executorHandler']").val( row.executorHandler );
            $("#addModal .form textarea[name='executorParam']").val( row.executorParam );
            $("#addModal .form input[name='childJobId']").val( row.childJobId );
            $('#addModal .form select[name=executorBlockStrategy] option[value='+ row.executorBlockStrategy +']').prop('selected', true);
            $('#addModal .form select[name=glueType] option[value='+ row.glueType +']').prop('selected', true);

            $("#addModal .form select[name=glueType]").change();

            // init-cronGen
            $("#addModal .form input[name='jobCron']").show().siblings().remove();
            $("#addModal .form input[name='jobCron']").cronGen({});

            // show
            $('#addModal').modal({backdrop: false, keyboard: false}).modal('show');
        });

    });

</script>

</body>
</html>