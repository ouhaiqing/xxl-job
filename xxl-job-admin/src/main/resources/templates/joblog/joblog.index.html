<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:include="include :: commonStyle" />
    <!-- DataTables -->
    <link rel="stylesheet" th:href="@{/static/adminlte/bower_components/datatables.net-bs/css/dataTables.bootstrap.min.css}">
    <!-- daterangepicker -->
    <link rel="stylesheet" th:href="@{/static/adminlte/bower_components/bootstrap-daterangepicker/daterangepicker.css}">

    <title th:text="#{admin_name}"></title>

</head>
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">
    <!-- header -->
    <th:block th:include="include :: commonHeader" />
    <!-- left -->
    <th:block th:include="include :: commonLeft('joblog')" />


    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h1 th:text="#{joblog_name}"></h1>
        </section>

        <!-- Main content -->
        <section class="content">
            <div class="row">
                <div class="col-xs-2">
                    <div class="input-group">
                        <span class="input-group-addon" th:text="#{jobinfo_field_jobgroup}"></span>
                        <select class="form-control" id="jobGroup"  paramVal="<#if jobInfo?exists>${jobInfo.jobGroup}</#if>" >
                                <option th:if="${XXL_JOB_LOGIN_IDENTITY.role}  == 1" value="0" th:text="#{system_all}"></option>
                                <option th:each="group:${JobGroupList}" th:text="${group.title}" th:value="${group.id}"></option>
                    </select>
                </div>
            </div>
            <div class="col-xs-2">
                <div class="input-group">
                    <span class="input-group-addon" th:text="#{jobinfo_job}"></span>
                    <select class="form-control" id="jobId" paramVal="<#if jobInfo?exists>${jobInfo.id}</#if>" >
                        <option value="0" th:text="#{system_all}"></option>
                    </select>
                </div>
            </div>

            <div class="col-xs-2">
                <div class="input-group">
                    <span class="input-group-addon" th:text="#{joblog_status}"></span>
                    <select class="form-control" id="logStatus" >
                        <option value="-1" th:text="#{joblog_status_all}"></option>
                        <option value="1" th:text="#{joblog_status_suc}"></option>
                        <option value="2" th:text="#{joblog_status_fail}"></option>
                        <option value="3" th:text="#{joblog_status_running}"></option>
                    </select>
                </div>
            </div>

            <div class="col-xs-4">
                <div class="input-group">
                		<span class="input-group-addon" th:text="#{joblog_field_triggerTime}">
	                	</span>
                    <input type="text" class="form-control" id="filterTime" readonly >
                </div>
            </div>

            <div class="col-xs-1">
                <button class="btn btn-block btn-info" id="searchBtn" th:text="#{system_search}"></button>
            </div>

            <div class="col-xs-1">
                <button class="btn btn-block btn-nomal" id="clearLog" th:text="#{joblog_clean}"></button>
            </div>
    </div>

    <div class="row">
        <div class="col-xs-12">
            <div class="box">
                <div class="box-body">
                    <table id="joblog_list" class="table table-bordered table-striped display" width="100%" >
                        <thead>
                        <tr>
                            <th name="jobId" th:text="#{jobinfo_field_id}"></th>
                            <th name="jobGroup" >jobGroup</th>
                            <th name="triggerTime" th:text="#{joblog_field_triggerTime}"></th>
                            <th name="triggerCode" th:text="#{joblog_field_triggerCode}"></th>
                            <th name="triggerMsg" th:text="#{joblog_field_triggerMsg}"></th>
                            <th name="handleTime" th:text="#{joblog_field_handleTime}"></th>
                            <th name="handleCode" th:text="#{joblog_field_handleCode}"></th>
                            <th name="handleMsg" th:text="#{joblog_field_handleMsg}"></th>
                            <th name="handleMsg" th:text="#{system_opt}"></th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    </section>
</div>

<!-- footer -->
    <th:block th:include="include :: commonFooter" />
</div>

<!-- 日志清理.模态框 -->
<div class="modal fade" id="clearLogModal" tabindex="-1" role="dialog"  aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" th:text="#{joblog_clean_log}"></h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal form" role="form" >
                    <div class="form-group">
                        <label class="col-sm-3 control-label" th:text="#{jobinfo_field_jobgroup}">：</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control jobGroupText" readonly >
                            <input type="hidden" name="jobGroup" >
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-3 control-label" th:text="#{jobinfo_job}">：</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control jobIdText" readonly >
                            <input type="hidden" name="jobId" >
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-3 control-label" th:text="#{joblog_clean_type}">:</label>
                        <div class="col-sm-9">
                            <select class="form-control" name="type" >
                                <option value="1" th:text="#{joblog_clean_type_1}"></option>
                                <option value="2" th:text="#{joblog_clean_type_2}"></option>
                                <option value="3" th:text="#{joblog_clean_type_3}"></option>
                                <option value="4" th:text="#{joblog_clean_type_4}"></option>
                                <option value="5" th:text="#{joblog_clean_type_5}"></option>
                                <option value="6" th:text="#{joblog_clean_type_6}"></option>
                                <option value="7" th:text="#{joblog_clean_type_7}"></option>
                                <option value="8" th:text="#{joblog_clean_type_8}"></option>
                                <option value="9" th:text="#{joblog_clean_type_9}"></option>
                            </select>
                        </div>
                    </div>

                    <hr>
                    <div class="form-group">
                        <div class="col-sm-offset-3 col-sm-6">
                            <button type="button" class="btn btn-primary ok" > th:text="#{system_ok}"></button>
                            <button type="button" class="btn btn-default" data-dismiss="modal"> th:text="#{system_cancel}"></button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<th:block th:include="include :: commonScript" />
<!-- DataTables -->
<script th:src="@{/static/adminlte/bower_components/datatables.net/js/jquery.dataTables.min.js}"></script>
<script th:src="@{/static/adminlte/bower_components/datatables.net-bs/js/dataTables.bootstrap.min.js}"></script>
<!-- daterangepicker -->
<script th:src="@{/static/adminlte/bower_components/moment/moment.min.js}"></script>
<script th:src="@{/static/adminlte/bower_components/bootstrap-daterangepicker/daterangepicker.js}"></script>

<!--<script th:src="@{/static/js/joblog.index.1.js}"></script>-->
<script type="text/javascript" th:inline="javascript">
    $(function() {

        // jobGroup change, job list init and select
        $("#jobGroup").on("change", function () {
            var jobGroup = $(this).children('option:selected').val();
            $.ajax({
                type : 'POST',
                async: false,   // async, avoid js invoke pagelist before jobId data init
                url : base_url + '/joblog/getJobsByGroup',
                data : {"jobGroup":jobGroup},
                dataType : "json",
                success : function(data){
                    if (data.code == 200) {
                        $("#jobId").html( '<option value="0" >'+ [[#{system_all}]] +'</option>' );
                        $.each(data.content, function (n, value) {
                            $("#jobId").append('<option value="' + value.id + '" >' + value.jobDesc + '</option>');
                        });
                        if ($("#jobId").attr("paramVal")){
                            $("#jobId").find("option[value='" + $("#jobId").attr("paramVal") + "']").attr("selected",true);
                        }
                    } else {
                        layer.open({
                            title: [[#{system_tips}]] ,
                            btn: [ [[#{system_ok}]] ],
                            content: (data.msg || [[#{system_api_error}]] ),
                            icon: '2'
                        });
                    }
                },
            });
        });
        if ($("#jobGroup").attr("paramVal")){
            $("#jobGroup").find("option[value='" + $("#jobGroup").attr("paramVal") + "']").attr("selected",true);
            $("#jobGroup").change();
        }

        // filter Time
        var rangesConf = {};
        rangesConf[ [[#{daterangepicker_ranges_recent_hour}]] ] = [moment().subtract(1, 'hours'), moment()];
        rangesConf[ [[#{daterangepicker_ranges_today}]] ] = [moment().startOf('day'), moment().endOf('day')];
        rangesConf[ [[#{daterangepicker_ranges_yesterday}]] ] = [moment().subtract(1, 'days').startOf('day'), moment().subtract(1, 'days').endOf('day')];
        rangesConf[ [[#{daterangepicker_ranges_this_month}]] ] = [moment().startOf('month'), moment().endOf('month')];
        rangesConf[ [[#{daterangepicker_ranges_last_month}]] ] = [moment().subtract(1, 'months').startOf('month'), moment().subtract(1, 'months').endOf('month')];
        rangesConf[ [[#{daterangepicker_ranges_recent_week}]] ] = [moment().subtract(1, 'weeks').startOf('day'), moment().endOf('day')];
        rangesConf[ [[#{daterangepicker_ranges_recent_month}]] ] = [moment().subtract(1, 'months').startOf('day'), moment().endOf('day')];

        $('#filterTime').daterangepicker({
            autoApply:false,
            singleDatePicker:false,
            showDropdowns:false,        // 是否显示年月选择条件
            timePicker: true, 			// 是否显示小时和分钟选择条件
            timePickerIncrement: 10, 	// 时间的增量，单位为分钟
            timePicker24Hour : true,
            opens : 'left', //日期选择框的弹出位置
            ranges: rangesConf,
            locale : {
                format: 'YYYY-MM-DD HH:mm:ss',
                separator : ' - ',
                customRangeLabel : [[#{daterangepicker_custom_name}]] ,
                applyLabel : [[#{system_ok}]] ,
                cancelLabel : [[#{system_cancel}]] ,
                fromLabel : [[#{daterangepicker_custom_starttime}]] ,
                toLabel : [[#{daterangepicker_custom_endtime}]] ,
                daysOfWeek : [[#{daterangepicker_custom_daysofweek}]].split(',') ,        // '日', '一', '二', '三', '四', '五', '六'
                monthNames : [[#{daterangepicker_custom_monthnames}]].split(',') ,        // '一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'
                firstDay : 1
            },
            startDate: rangesConf[ [[#{daterangepicker_ranges_today}]] ][0],
            endDate: rangesConf[ [[#{daterangepicker_ranges_today}]] ][1]
        });

        // init date tables
        var logTable = $("#joblog_list").dataTable({
            "deferRender": true,
            "processing" : true,
            "serverSide": true,
            "ajax": {
                url: base_url + "/joblog/pageList" ,
                type:"post",
                data : function ( d ) {
                    var obj = {};
                    obj.jobGroup = $('#jobGroup').val();
                    obj.jobId = $('#jobId').val();
                    obj.logStatus = $('#logStatus').val();
                    obj.filterTime = $('#filterTime').val();
                    obj.start = d.start;
                    obj.length = d.length;
                    return obj;
                }
            },
            "searching": false,
            "ordering": false,
            //"scrollX": false,
            "columns": [
                {
                    "data": 'jobId',
                    "visible" : true,
                    "width":'10%',
                    "render": function ( data, type, row ) {

                        var jobhandler = '';
                        if (row.executorHandler) {
                            jobhandler = "<br>JobHandler：" + row.executorHandler;
                        }

                        var temp = '';
                        temp += [[#{joblog_field_executorAddress}]] + '：' + (row.executorAddress?row.executorAddress:'');
                        temp += jobhandler;
                        temp += '<br>'+ [[#{jobinfo_field_executorparam}]] +'：' + row.executorParam;

                        return '<a class="logTips" href="javascript:;" >'+ row.jobId +'<span style="display:none;">'+ temp +'</span></a>';
                    }
                },
                { "data": 'jobGroup', "visible" : false},
                {
                    "data": 'triggerTime',
                    "width":'20%',
                    "render": function ( data, type, row ) {
                        return data?moment(new Date(data)).format("YYYY-MM-DD HH:mm:ss"):"";
                    }
                },
                {
                    "data": 'triggerCode',
                    "width":'10%',
                    "render": function ( data, type, row ) {
                        var html = data;
                        if (data == 200) {
                            html = '<span style="color: green">'+ [[#{system_success}]] +'</span>';
                        } else if (data == 500) {
                            html = '<span style="color: red">'+ [[#{system_fail}]] +'</span>';
                        } else if (data == 0) {
                            html = '';
                        }
                        return html;
                    }
                },
                {
                    "data": 'triggerMsg',
                    "width":'10%',
                    "render": function ( data, type, row ) {
                        return data?'<a class="logTips" href="javascript:;" >'+ [[#{system_show}]] +'<span style="display:none;">'+ data +'</span></a>':[[#{system_empty}]];
                    }
                },
                {
                    "data": 'handleTime',
                    "width":'20%',
                    "render": function ( data, type, row ) {
                        return data?moment(new Date(data)).format("YYYY-MM-DD HH:mm:ss"):"";
                    }
                },
                {
                    "data": 'handleCode',
                    "width":'10%',
                    "render": function ( data, type, row ) {
                        var html = data;
                        if (data == 200) {
                            html = '<span style="color: green">'+ [[#{joblog_handleCode_200}]] +'</span>';
                        } else if (data == 500) {
                            html = '<span style="color: red">'+ [[#{joblog_handleCode_500}]] +'</span>';
                        } else if (data == 502) {
                            html = '<span style="color: red">'+ [[#{joblog_handleCode_502}]] +'</span>';
                        } else if (data == 0) {
                            html = '';
                        }
                        return html;
                    }
                },
                {
                    "data": 'handleMsg',
                    "width":'10%',
                    "render": function ( data, type, row ) {
                        return data?'<a class="logTips" href="javascript:;" >'+ [[#{system_show}]] +'<span style="display:none;">'+ data +'</span></a>':[[#{system_empty}]];
                    }
                },
                {
                    "data": 'handleMsg' ,
                    "bSortable": false,
                    "width":'10%',
                    "render": function ( data, type, row ) {
                        // better support expression or string, not function
                        return function () {
                            if (row.triggerCode == 200 || row.handleCode != 0){

                                /*var temp = '<a href="javascript:;" class="logDetail" _id="'+ row.id +'">'+ [[#{joblog_rolling_log}]] +'</a>';
                                if(row.handleCode == 0){
                                    temp += '<br><a href="javascript:;" class="logKill" _id="'+ row.id +'" style="color: red;" >'+ [[#{joblog_kill_log}]] +'</a>';
                                }*/
                                //return temp;

                                var html = '<div class="btn-group">\n' +
                                    '     <button type="button" class="btn btn-primary btn-sm">'+ [[#{system_opt}]] +'</button>\n' +
                                    '     <button type="button" class="btn btn-primary btn-sm dropdown-toggle" data-toggle="dropdown">\n' +
                                    '       <span class="caret"></span>\n' +
                                    '       <span class="sr-only">Toggle Dropdown</span>\n' +
                                    '     </button>\n' +
                                    '     <ul class="dropdown-menu" role="menu" _id="'+ row.id +'" >\n' +
                                    '       <li><a href="javascript:void(0);" class="logDetail" _id="'+ row.id +'" >'+ [[#{joblog_rolling_log}]] +'</a></li>\n' +
                                    '       <li class="divider"></li>\n' +
                                    '       <li><a href="javascript:void(0);" class="logKill" _id="'+ row.id +'" >'+ [[#{joblog_kill_log}]] +'</a></li>\n' +
                                    '     </ul>\n' +
                                    '   </div>';

                                return html;
                            }
                            return null;
                        }
                    }
                }
            ],
            "language" : {
                "sProcessing" : [[#{dataTable_sProcessing}]] ,
                "sLengthMenu" : [[#{dataTable_sLengthMenu}]] ,
                "sZeroRecords" : [[#{dataTable_sZeroRecords}]] ,
                "sInfo" : [[#{dataTable_sInfo}]] ,
                "sInfoEmpty" : [[#{dataTable_sInfoEmpty}]] ,
                "sInfoFiltered" : [[#{dataTable_sInfoFiltered}]] ,
                "sInfoPostFix" : "",
                "sSearch" : [[#{dataTable_sSearch}]] ,
                "sUrl" : "",
                "sEmptyTable" : [[#{dataTable_sEmptyTable}]] ,
                "sLoadingRecords" : [[#{dataTable_sLoadingRecords}]] ,
                "sInfoThousands" : ",",
                "oPaginate" : {
                    "sFirst" : [[#{dataTable_sFirst}]] ,
                    "sPrevious" : [[#{dataTable_sPrevious}]] ,
                    "sNext" : [[#{dataTable_sNext}]] ,
                    "sLast" : [[#{dataTable_sLast}]]
                },
                "oAria" : {
                    "sSortAscending" : [[#{dataTable_sSortAscending}]] ,
                    "sSortDescending" : [[#{dataTable_sSortDescending}]]
                }
            }
        });
        logTable.on('xhr.dt',function(e, settings, json, xhr) {
            if (json.code && json.code != 200) {
                layer.msg( json.msg || [[#{system_api_error}]] );
            }
        });

        // logTips alert
        $('#joblog_list').on('click', '.logTips', function(){
            var msg = $(this).find('span').html();
            ComAlertTec.show(msg);
        });

        // search Btn
        $('#searchBtn').on('click', function(){
            logTable.fnDraw();
        });

        // logDetail look
        $('#joblog_list').on('click', '.logDetail', function(){
            var _id = $(this).attr('_id');

            window.open(base_url + '/joblog/logDetailPage?id=' + _id);
            return;
        });

        /**
         * log Kill
         */
        $('#joblog_list').on('click', '.logKill', function(){
            var _id = $(this).attr('_id');

            layer.confirm( ([[#{system_ok}]] + [[#{joblog_kill_log}]] + '?'), {
                icon: 3,
                title: [[#{system_tips}]] ,
                btn: [ [[#{system_ok}]], [[#{system_cancel}]] ]
            }, function(index){
                layer.close(index);

                $.ajax({
                    type : 'POST',
                    url : base_url + '/joblog/logKill',
                    data : {"id":_id},
                    dataType : "json",
                    success : function(data){
                        if (data.code == 200) {
                            layer.open({
                                title: [[#{system_tips}]],
                                btn: [ [[#{system_ok}]] ],
                                content: [[#{system_opt_suc}]] ,
                                icon: '1',
                                end: function(layero, index){
                                    logTable.fnDraw();
                                }
                            });
                        } else {
                            layer.open({
                                title: [[#{system_tips}]],
                                btn: [ [[#{system_ok}]] ],
                                content: (data.msg || [[#{system_opt_fail}]] ),
                                icon: '2'
                            });
                        }
                    },
                });
            });

        });

        /**
         * clear Log
         */
        $('#clearLog').on('click', function(){

            var jobGroup = $('#jobGroup').val();
            var jobId = $('#jobId').val();

            var jobGroupText = $("#jobGroup").find("option:selected").text();
            var jobIdText = $("#jobId").find("option:selected").text();

            $('#clearLogModal input[name=jobGroup]').val(jobGroup);
            $('#clearLogModal input[name=jobId]').val(jobId);

            $('#clearLogModal .jobGroupText').val(jobGroupText);
            $('#clearLogModal .jobIdText').val(jobIdText);

            $('#clearLogModal').modal('show');

        });
        $("#clearLogModal .ok").on('click', function(){
            $.post(base_url + "/joblog/clearLog",  $("#clearLogModal .form").serialize(), function(data, status) {
                if (data.code == "200") {
                    $('#clearLogModal').modal('hide');
                    layer.open({
                        title: [[#{system_tips}]] ,
                        btn: [ [[#{system_ok}]] ],
                        content: ([[#{joblog_clean_log}]] + [[#{system_success}]]) ,
                        icon: '1',
                        end: function(layero, index){
                            logTable.fnDraw();
                        }
                    });
                } else {
                    layer.open({
                        title: [[#{system_tips}]] ,
                        btn: [ [[#{system_ok}]] ],
                        content: (data.msg || ([[#{joblog_clean_log}]] + [[#{system_fail}]]) ),
                        icon: '2'
                    });
                }
            });
        });
        $("#clearLogModal").on('hide.bs.modal', function () {
            $("#clearLogModal .form")[0].reset();
        });

    });


    // Com Alert by Tec theme
    var ComAlertTec = {
        html:function(){
            var html =
                '<div class="modal fade" id="ComAlertTec" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">' +
                '	<div class="modal-dialog modal-lg-">' +
                '		<div class="modal-content-tec">' +
                '			<div class="modal-body">' +
                '				<div class="alert" style="color:#fff;word-wrap: break-word;">' +
                '				</div>' +
                '			</div>' +
                '				<div class="modal-footer">' +
                '				<div class="text-center" >' +
                '					<button type="button" class="btn btn-info ok" data-dismiss="modal" >'+ [[#{system_ok}]] +'</button>' +
                '				</div>' +
                '			</div>' +
                '		</div>' +
                '	</div>' +
                '</div>';
            return html;
        },
        show:function(msg, callback){
            // dom init
            if ($('#ComAlertTec').length == 0){
                $('body').append(ComAlertTec.html());
            }

            // init com alert
            $('#ComAlertTec .alert').html(msg);
            $('#ComAlertTec').modal('show');

            $('#ComAlertTec .ok').click(function(){
                $('#ComAlertTec').modal('hide');
                if(typeof callback == 'function') {
                    callback();
                }
            });
        }
    };

</script>
</body>
</html>
