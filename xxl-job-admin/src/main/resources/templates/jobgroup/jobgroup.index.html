<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:include="include :: commonStyle" />
    <link rel="stylesheet" th:href="@{/static/adminlte/bower_components/datatables.net-bs/css/dataTables.bootstrap.min.css}">
    <title th:text="#{admin_name}"></title>
</head>
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">
    <!-- header -->
    <th:block th:include="include :: commonHeader" />
    <!-- left -->
    <th:block th:include="include :: commonLeft('jobgroup')" />

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h1 th:text="#{jobgroup_name}"></h1>
        </section>

        <!-- Main content -->
        <section class="content">

            <div class="row">
                <div class="col-xs-3">
                    <div class="input-group">
                        <span class="input-group-addon">AppName</span>
                        <input type="text" class="form-control" id="appname" autocomplete="on" th:placeholder="#{system_please_input} + AppName" >
                    </div>
                </div>
                <div class="col-xs-3">
                    <div class="input-group">
                        <span class="input-group-addon" th:text="#{jobgroup_field_title}"></span>
                        <input type="text" class="form-control" id="title" autocomplete="on" th:placeholder="#{jobgroup_field_title}" >
                    </div>
                </div>
                <div class="col-xs-2">
                    <button class="btn btn-block btn-info" id="searchBtn" th:text="#{system_search}"></button>
                </div>
                <div class="col-xs-2">
                    <button class="btn btn-block btn-success add" type="button" th:text="#{jobinfo_field_add}"></button>
                </div>
            </div>

            <div class="row">
                <div class="col-xs-12">
                    <div class="box">
                        <div class="box-body">
                            <table id="jobgroup_list" class="table table-bordered table-striped display" width="100%" >
                                <thead>
                                <tr>
                                    <th name="id" >ID</th>
                                    <th name="appname" >AppName</th>
                                    <th name="title"  th:text="#{jobgroup_field_title}"></th>
                                    <th name="addressType"  th:text="#{jobgroup_field_addressType}"></th>
                                    <th name="registryList" th:text="OnLine +' '+ #{jobgroup_field_registryList}"></th>
                                    <th th:text="#{system_opt}"></th>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- 新增.模态框 -->
    <div class="modal fade" id="addModal" tabindex="-1" role="dialog"  aria-hidden="true">
        <div class="modal-dialog ">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title"  th:text="#{jobgroup_add}"></h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal form" role="form" >
                        <div class="form-group">
                            <label for="lastname" class="col-sm-2 control-label">AppName<font color="red">*</font></label>
                            <div class="col-sm-10"><input type="text" class="form-control" name="appname" th:placeholder="#{system_please_input} + AppName" maxlength="64" ></div>
                        </div>
                        <div class="form-group">
                            <label for="lastname" class="col-sm-2 control-label" th:text="#{jobgroup_field_title}"><font color="red">*</font></label>
                            <div class="col-sm-10"><input type="text" class="form-control" name="title" th:placeholder="#{system_please_input} + #{jobgroup_field_title}" maxlength="12" ></div>
                        </div>
                        <div class="form-group">
                            <label for="lastname" class="col-sm-2 control-label" th:text="#{jobgroup_field_addressType}"><font color="red">*</font></label>
                            <div class="col-sm-10">
                                <input type="radio" name="addressType" value="0" checked  th:text="#{jobgroup_field_addressType_0}"/>
                                &nbsp;&nbsp;&nbsp;&nbsp;
                                <input type="radio" name="addressType" value="1" th:text="#{jobgroup_field_addressType_1}"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="lastname" class="col-sm-2 control-label" th:text="#{jobgroup_field_registryList}"><font color="red">*</font></label>
                            <div class="col-sm-10">
                                <textarea class="textarea" name="addressList" maxlength="512" th:placeholder="#{jobgroup_field_registryList_placeholder}" readonly="readonly" style="background-color:#eee; width: 100%; height: 100px; font-size: 14px; line-height: 15px; border: 1px solid #dddddd; padding: 5px;"></textarea>
                            </div>
                        </div>
                        <hr>
                        <div class="form-group">
                            <div class="col-sm-offset-3 col-sm-6">
                                <button type="submit" class="btn btn-primary" th:text="#{system_save}"></button>
                                <button type="button" class="btn btn-default" data-dismiss="modal" th:text="#{system_cancel}"></button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 更新.模态框 -->
    <div class="modal fade" id="updateModal" tabindex="-1" role="dialog"  aria-hidden="true">
        <div class="modal-dialog ">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title"  th:text="#{jobgroup_edit}"></h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal form" role="form" >
                        <div class="form-group">
                            <label for="lastname" class="col-sm-2 control-label">AppName<font color="red">*</font></label>
                            <div class="col-sm-10"><input type="text" class="form-control" name="appname" th:placeholder="#{system_please_input} + AppName" maxlength="64" ></div>
                        </div>
                        <div class="form-group">
                            <label for="lastname" class="col-sm-2 control-label" th:text="#{jobgroup_field_title}"><font color="red">*</font></label>
                            <div class="col-sm-10"><input type="text" class="form-control" name="title" th:placeholder="#{system_please_input} + #{jobgroup_field_title}" maxlength="12" ></div>
                        </div>
                        <div class="form-group">
                            <label for="lastname" class="col-sm-2 control-label" th:text="#{jobgroup_field_addressType}"><font color="red">*</font></label>
                            <div class="col-sm-10">
                                <input type="radio" name="addressType" value="0" th:text="#{jobgroup_field_addressType_0}"/>
                                &nbsp;&nbsp;&nbsp;&nbsp;
                                <input type="radio" name="addressType" value="1" th:text="#{jobgroup_field_addressType_1}"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="lastname" class="col-sm-2 control-label" th:text="#{jobgroup_field_registryList}"><font color="red">*</font></label>
                            <div class="col-sm-10">
                                <textarea class="textarea" name="addressList" maxlength="512" th:placeholder="#{jobgroup_field_registryList_placeholder}" readonly="readonly" style="background-color:#eee; width: 100%; height: 100px; font-size: 14px; line-height: 15px; border: 1px solid #dddddd; padding: 5px;"></textarea>
                            </div>
                        </div>
                        <hr>
                        <div class="form-group">
                            <div class="col-sm-offset-3 col-sm-6">
                                <button type="submit" class="btn btn-primary" th:text="#{system_save}"></button>
                                <button type="button" class="btn btn-default" data-dismiss="modal" th:text="#{system_cancel}"></button>
                                <input type="hidden" name="id" >
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- footer -->
    <th:block th:include="include :: commonFooter" />
</div>
<th:block th:include="include :: commonScript" />
<!-- DataTables -->
<script th:src="@{/static/adminlte/bower_components/datatables.net/js/jquery.dataTables.min.js}"></script>
<script th:src="@{/static/adminlte/bower_components/datatables.net-bs/js/dataTables.bootstrap.min.js}"></script>

<!--<script th:src="@{/static/js/jobgroup.index.1.js}"></script>-->
<script type="text/javascript" th:inline="javascript">
    $(function() {

        // init date tables
        var jobGroupTable = $("#jobgroup_list").dataTable({
            "deferRender": true,
            "processing" : true,
            "serverSide": true,
            "ajax": {
                url: base_url + "/jobgroup/pageList",
                type:"post",
                data : function ( d ) {
                    var obj = {};
                    obj.appname = $('#appname').val();
                    obj.title = $('#title').val();
                    obj.start = d.start;
                    obj.length = d.length;
                    return obj;
                }
            },
            "searching": false,
            "ordering": false,
            //"scrollX": true,	// scroll x，close self-adaption
            "columns": [
                {
                    "data": 'id',
                    "visible" : false
                },
                {
                    "data": 'appname',
                    "visible" : true,
                    "width":'30%'
                },
                {
                    "data": 'title',
                    "visible" : true,
                    "width":'30%'
                },
                {
                    "data": 'addressType',
                    "width":'10%',
                    "visible" : true,
                    "render": function ( data, type, row ) {
                        if (row.addressType == 0) {
                            return [[#{jobgroup_field_addressType_0}]];
                        } else {
                            return [[#{jobgroup_field_addressType_1}]];
                        }
                    }
                },
                {
                    "data": 'registryList',
                    "width":'15%',
                    "visible" : true,
                    "render": function ( data, type, row ) {
                        return row.registryList
                            ?'<a class="show_registryList" href="javascript:;" _id="'+ row.id +'" >'
                            + [[#{system_show}]] +' ( ' + row.registryList.length+ ' ）</a>'
                            :[[#{system_empty}]];
                    }
                },
                {
                    "data": [[#{system_opt}]] ,
				"width":'15%',
				"render": function ( data, type, row ) {
					return function(){
						// data
						tableData['key'+row.id] = row;

						// opt
						var html = '<div class="btn-group">\n' +
							'     <button type="button" class="btn btn-primary btn-sm">'+ [[#{system_opt}]] +'</button>\n' +
                        '     <button type="button" class="btn btn-primary btn-sm dropdown-toggle" data-toggle="dropdown">\n' +
                        '       <span class="caret"></span>\n' +
                        '       <span class="sr-only">Toggle Dropdown</span>\n' +
                        '     </button>\n' +
                        '     <ul class="dropdown-menu" role="menu" _id="'+ row.id +'" >\n' +
                        '       <li><a href="javascript:void(0);" class="opt_edit" >'+ [[#{system_opt_edit}]] +'</a></li>\n' +
                        '       <li><a href="javascript:void(0);" class="opt_del" >'+ [[#{system_opt_del}]] +'</a></li>\n' +
                        '     </ul>\n' +
                        '   </div>';

        return html;
    };
    }
    }
    ],
    "language" : {
        "sProcessing" : [[#{dataTable_sProcessing}]] ,
            "sLengthMenu" : [[#{dataTable_sLengthMenu}]] ,
            "sZeroRecords" : [[#{dataTable_sZeroRecords}]] ,
            "sInfo" : [[#{dataTable_sInfo}]] ,
            "sInfoEmpty" : [[#{dataTable_sInfoEmpty}]] ,
            "sInfoFiltered" : [[#{dataTable_sInfoFiltered}]] ,
            "sInfoPostFix" : "",
            "sSearch" : [[#{dataTable_sSearch}]] ,
            "sUrl" : "",
            "sEmptyTable" : [[#{dataTable_sEmptyTable}]] ,
            "sLoadingRecords" : [[#{dataTable_sLoadingRecords}]] ,
            "sInfoThousands" : ",",
            "oPaginate" : {
            "sFirst" : [[#{dataTable_sFirst}]] ,
                "sPrevious" : [[#{dataTable_sPrevious}]] ,
                "sNext" : [[#{dataTable_sNext}]] ,
                "sLast" : [[#{dataTable_sLast}]]
        },
        "oAria" : {
            "sSortAscending" : [[#{dataTable_sSortAscending}]] ,
                "sSortDescending" : [[#{dataTable_sSortDescending}]]
        }
    }
    });

    // table data
    var tableData = {};

    // search btn
    $('#searchBtn').on('click', function(){
        jobGroupTable.fnDraw();
    });

    // job registryinfo
    $("#jobgroup_list").on('click', '.show_registryList',function() {
        var id = $(this).attr("_id");
        var row = tableData['key'+id];

        var html = '<div>';
        if (row.registryList) {
            for (var index in row.registryList) {
                html += (parseInt(index)+1) + '. <span class="badge bg-green" >' + row.registryList[index] + '</span><br>';
            }
        }
        html += '</div>';

        layer.open({
            title: [[#{jobinfo_opt_registryinfo}]] ,
            btn: [ [[#{system_ok}]] ],
            content: html
        });

    });


    // opt_del
    $("#jobgroup_list").on('click', '.opt_del',function() {
        var id = $(this).parents('ul').attr("_id");

        layer.confirm( ([[#{system_ok}]] + [[#{jobgroup_del}]] + '？') , {
            icon: 3,
            title: [[#{system_tips}]] ,
            btn: [ [[#{system_ok}]], [[#{system_cancel}]] ]
        }, function(index){
            layer.close(index);

            $.ajax({
                type : 'POST',
                url : base_url + '/jobgroup/remove',
                data : {"id":id},
                dataType : "json",
                success : function(data){
                    if (data.code == 200) {
                        layer.open({
                            title: [[#{system_tips}]] ,
                            btn: [ [[#{system_ok}]] ],
                            content: ([[#{jobgroup_del}]] + [[#{system_success}]]),
                            icon: '1',
                            end: function(layero, index){
                                jobGroupTable.fnDraw();
                            }
                        });
                    } else {
                        layer.open({
                            title: [[#{system_tips}]],
                            btn: [ [[#{system_ok}]] ],
                            content: (data.msg || ([[#{jobgroup_del}]] + [[#{system_fail}]])),
                            icon: '2'
                        });
                    }
                },
            });
        });
    });


    // jquery.validate “low letters start, limit contants、 letters、numbers and line-through.”
    jQuery.validator.addMethod("myValid01", function(value, element) {
        var length = value.length;
        var valid = /^[a-z][a-zA-Z0-9-]*$/;
        return this.optional(element) || valid.test(value);
    }, [[#{jobgroup_field_appname_limit}]] );

    $('.add').on('click', function(){
        $('#addModal').modal({backdrop: false, keyboard: false}).modal('show');
    });
    var addModalValidate = $("#addModal .form").validate({
        errorElement : 'span',
        errorClass : 'help-block',
        focusInvalid : true,
        rules : {
            appname : {
                required : true,
                rangelength:[4,64],
                myValid01 : true
            },
            title : {
                required : true,
                rangelength:[4, 12]
            }
        },
        messages : {
            appname : {
                required : [[#{system_please_input}]] + "AppName",
                rangelength: [[#{jobgroup_field_appname_length}]] ,
                myValid01: [[#{jobgroup_field_appname_limit}]]
            },
            title : {
                required : [[#{system_please_input}]] + [[#{jobgroup_field_title}]] ,
                rangelength: [[#{jobgroup_field_title_length}]]
            }
        },
        highlight : function(element) {
            $(element).closest('.form-group').addClass('has-error');
        },
        success : function(label) {
            label.closest('.form-group').removeClass('has-error');
            label.remove();
        },
        errorPlacement : function(error, element) {
            element.parent('div').append(error);
        },
        submitHandler : function(form) {
            $.post(base_url + "/jobgroup/save",  $("#addModal .form").serialize(), function(data, status) {
                if (data.code == "200") {
                    $('#addModal').modal('hide');
                    layer.open({
                        title: [[#{system_tips}]] ,
                        btn: [ [[#{system_ok }]]],
                        content: [[#{system_add_suc}]] ,
                        icon: '1',
                        end: function(layero, index){
                            jobGroupTable.fnDraw();
                        }
                    });
                } else {
                    layer.open({
                        title: [[#{system_tips}]],
                        btn: [ [[#{system_ok}]] ],
                        content: (data.msg || [[#{system_add_fail}]]  ),
                        icon: '2'
                    });
                }
            });
        }
    });
    $("#addModal").on('hide.bs.modal', function () {
        $("#addModal .form")[0].reset();
        addModalValidate.resetForm();
        $("#addModal .form .form-group").removeClass("has-error");
    });

    // addressType change

    $("#addModal input[name=addressType], #updateModal input[name=addressType]").click(function(){
        var addressType = $(this).val();
        var $addressList = $(this).parents("form").find("textarea[name=addressList]");
        if (addressType == 0) {
            $addressList.css("background-color", "#eee");	// 自动注册
            $addressList.attr("readonly","readonly");
            $addressList.val("");
        } else {
            $addressList.css("background-color", "white");
            $addressList.removeAttr("readonly");
        }
    });


    // opt_edit
    $("#jobgroup_list").on('click', '.opt_edit',function() {
        var id = $(this).parents('ul').attr("_id");
        var row = tableData['key'+id];

        $("#updateModal .form input[name='id']").val( row.id );
        $("#updateModal .form input[name='appname']").val( row.appname );
        $("#updateModal .form input[name='title']").val( row.title );

        // 注册方式
        $("#updateModal .form input[name='addressType']").removeAttr('checked');
        $("#updateModal .form input[name='addressType'][value='"+ row.addressType +"']").click();
        // 机器地址
        $("#updateModal .form textarea[name='addressList']").val( row.addressList );

        $('#updateModal').modal({backdrop: false, keyboard: false}).modal('show');
    });
    var updateModalValidate = $("#updateModal .form").validate({
        errorElement : 'span',
        errorClass : 'help-block',
        focusInvalid : true,
        rules : {
            appname : {
                required : true,
                rangelength:[4,64],
                myValid01 : true
            },
            title : {
                required : true,
                rangelength:[4, 12]
            }
        },
        messages : {
            appname : {
                required : [[#{system_please_input}]]+"AppName",
                rangelength: [[#{jobgroup_field_appname_length}]] ,
                myValid01: [[#{jobgroup_field_appname_limit}]]
            },
            title : {
                required : [[#{system_please_input}]] + [[#{jobgroup_field_title}]] ,
                rangelength: [[#{jobgroup_field_title_length}]]
            }
        },
        highlight : function(element) {
            $(element).closest('.form-group').addClass('has-error');
        },
        success : function(label) {
            label.closest('.form-group').removeClass('has-error');
            label.remove();
        },
        errorPlacement : function(error, element) {
            element.parent('div').append(error);
        },
        submitHandler : function(form) {
            $.post(base_url + "/jobgroup/update",  $("#updateModal .form").serialize(), function(data, status) {
                if (data.code == "200") {
                    $('#updateModal').modal('hide');

                    layer.open({
                        title: [[#{system_tips}]] ,
                        btn: [ [[#{system_ok}]] ],
                        content: [[#{system_update_suc}]] ,
                        icon: '1',
                        end: function(layero, index){
                            jobGroupTable.fnDraw();
                        }
                    });
                } else {
                    layer.open({
                        title: [[#{system_tips}]],
                        btn: [ [[#{system_ok}]] ],
                        content: (data.msg || [[#{system_update_fail}]]  ),
                        icon: '2'
                    });
                }
            });
        }
    });
    $("#updateModal").on('hide.bs.modal', function () {
        $("#updateModal .form")[0].reset();
        addModalValidate.resetForm();
        $("#updateModal .form .form-group").removeClass("has-error");
    });


    });

</script>
</body>
</html>
